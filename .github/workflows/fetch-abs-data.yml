name: Fetch ABS Data Snapshot

on:
  # Run on the 2nd of every month at 02:00 UTC — shortly after typical ABS release dates
  schedule:
    - cron: "0 2 2 * *"

  # Allow manual runs from the Actions tab (useful for initial setup / backfill)
  workflow_dispatch:
    inputs:
      start_period:
        description: "Start period for CPI (e.g. 2000-Q1). AWE start year is derived automatically."
        required: false
        default: ""

jobs:
  fetch-abs:
    name: Snapshot CPI and AWE from ABS Data API
    runs-on: ubuntu-latest

    env:
      ABS_API:    "https://data.api.abs.gov.au/rest/data"
      USER_AGENT: "AustralianAbundanceIndex/1.0 (github-actions; open-source research)"

      # ── CPI ──────────────────────────────────────────────────────────────────
      # Quarterly All Groups CPI, weighted average of 8 capital cities
      # Key structure: MEASURE.REGION.FREQ
      #   MEASURE = 10  → All groups CPI, Index Numbers
      #   REGION  = 50  → Weighted average of eight capital cities
      #   FREQ    = Q   → Quarterly
      CPI_DATAFLOW: "ABS,CPI"
      CPI_KEY:      "10.50.Q"
      CPI_START:    "2000-Q1"

      # ── AWE ──────────────────────────────────────────────────────────────────
      # Average Weekly Earnings, semi-annual (May / November reference periods)
      # Key structure: MEASURE.EMP_TYPE.INDUSTRY.TSEST.REGION.FREQ
      #   MEASURE   = 1   → Average Weekly Total Earnings
      #   EMP_TYPE  = 3   → All employees
      #   INDUSTRY  = 3   → All industries
      #   TSEST     = 20  → Original (not seasonally adjusted)
      #   REGION    = AUS → Australia
      #   FREQ      = S   → Semi-annual
      AWE_DATAFLOW: "ABS,AWE"
      AWE_KEY:      "1.3.3.20.AUS.S"
      AWE_START:    "2000"           # ABS AWE API accepts year-only for semi-annual

    steps:

      # ── 1. Checkout repo so we can commit the snapshots back ─────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Create output directory structure ─────────────────────────────────
      - name: Create data directories
        run: |
          mkdir -p data/cpi data/awe

      # ── 3. Resolve start periods into env vars for all subsequent steps ───────
      # CPI accepts "2000-Q1" format; AWE accepts year-only ("2000").
      # If a manual start_period was provided (e.g. "2003-Q2"), derive the AWE
      # start year from it using cut. Otherwise fall back to the defaults above.
      - name: Resolve start periods
        run: |
          INPUT="${{ github.event.inputs.start_period }}"
          if [ -n "$INPUT" ]; then
            CPI_START_RESOLVED="$INPUT"
            AWE_START_RESOLVED="$(echo "$INPUT" | cut -d'-' -f1)"
          else
            CPI_START_RESOLVED="$CPI_START"
            AWE_START_RESOLVED="$AWE_START"
          fi
          echo "CPI_START_RESOLVED=$CPI_START_RESOLVED" >> "$GITHUB_ENV"
          echo "AWE_START_RESOLVED=$AWE_START_RESOLVED" >> "$GITHUB_ENV"
          echo "CPI start : $CPI_START_RESOLVED"
          echo "AWE start : $AWE_START_RESOLVED"

      # ── 4a. Fetch CPI — JSON ─────────────────────────────────────────────────
      - name: Fetch CPI (JSON)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+json;version=1.0" \
            "$ABS_API/$CPI_DATAFLOW/$CPI_KEY?startPeriod=$CPI_START_RESOLVED&detail=full" \
            -o data/cpi/cpi.json
          echo "CPI JSON: $(wc -c < data/cpi/cpi.json) bytes"

      # ── 4b. Fetch CPI — XML (SDMX-ML 2.1) ───────────────────────────────────
      - name: Fetch CPI (XML)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+xml;version=2.1" \
            "$ABS_API/$CPI_DATAFLOW/$CPI_KEY?startPeriod=$CPI_START_RESOLVED&detail=full" \
            -o data/cpi/cpi.xml
          echo "CPI XML: $(wc -c < data/cpi/cpi.xml) bytes"

      # ── 4c. Fetch CPI — CSV (SDMX-CSV, easiest for JS consumption) ──────────
      - name: Fetch CPI (CSV)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+csv;version=1.0.0" \
            "$ABS_API/$CPI_DATAFLOW/$CPI_KEY?startPeriod=$CPI_START_RESOLVED&detail=dataonly" \
            -o data/cpi/cpi.csv
          echo "CPI CSV rows: $(wc -l < data/cpi/cpi.csv)"

      # ── 5a. Fetch AWE — JSON ─────────────────────────────────────────────────
      - name: Fetch AWE (JSON)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+json;version=1.0" \
            "$ABS_API/$AWE_DATAFLOW/$AWE_KEY?startPeriod=$AWE_START_RESOLVED&detail=full" \
            -o data/awe/awe.json
          echo "AWE JSON: $(wc -c < data/awe/awe.json) bytes"

      # ── 5b. Fetch AWE — XML ──────────────────────────────────────────────────
      - name: Fetch AWE (XML)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+xml;version=2.1" \
            "$ABS_API/$AWE_DATAFLOW/$AWE_KEY?startPeriod=$AWE_START_RESOLVED&detail=full" \
            -o data/awe/awe.xml
          echo "AWE XML: $(wc -c < data/awe/awe.xml) bytes"

      # ── 5c. Fetch AWE — CSV ──────────────────────────────────────────────────
      - name: Fetch AWE (CSV)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+csv;version=1.0.0" \
            "$ABS_API/$AWE_DATAFLOW/$AWE_KEY?startPeriod=$AWE_START_RESOLVED&detail=dataonly" \
            -o data/awe/awe.csv
          echo "AWE CSV rows: $(wc -l < data/awe/awe.csv)"

      # ── 6. Validate files are non-empty ──────────────────────────────────────
      - name: Validate downloads
        run: |
          for f in data/cpi/cpi.json data/cpi/cpi.xml data/cpi/cpi.csv \
                   data/awe/awe.json data/awe/awe.xml data/awe/awe.csv; do
            if [ ! -s "$f" ]; then
              echo "ERROR: $f is empty or missing"
              exit 1
            fi
            echo "OK: $f ($(wc -c < $f) bytes)"
          done

      # ── 7. Write a metadata sidecar with fetch timestamp and source URLs ─────
      - name: Write fetch metadata
        run: |
          cat > data/fetch-metadata.json <<EOF
          {
            "fetched_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "sources": {
              "cpi": {
                "dataflow": "$CPI_DATAFLOW",
                "key": "$CPI_KEY",
                "start_period": "$CPI_START_RESOLVED",
                "url": "$ABS_API/$CPI_DATAFLOW/$CPI_KEY"
              },
              "awe": {
                "dataflow": "$AWE_DATAFLOW",
                "key": "$AWE_KEY",
                "start_period": "$AWE_START_RESOLVED",
                "url": "$ABS_API/$AWE_DATAFLOW/$AWE_KEY"
              }
            },
            "notes": {
              "cpi_measure": "10 = All groups CPI, Index Numbers",
              "cpi_region":  "50 = Weighted average of eight capital cities",
              "cpi_freq":    "Q = Quarterly",
              "awe_measure": "1 = Average Weekly Total Earnings",
              "awe_emp":     "3 = All employees",
              "awe_industry":"3 = All industries",
              "awe_tsest":   "20 = Original (not seasonally adjusted)",
              "awe_freq":    "S = Semi-annual (May / November reference periods)"
            }
          }
          EOF

      # ── 8. Commit and push updated data files ────────────────────────────────
      - name: Commit snapshot to repository
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          # Only commit if there are actual changes
          if git diff --staged --quiet; then
            echo "No data changes detected — ABS has not updated since last run."
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "data: ABS snapshot ${TIMESTAMP}

          Updated files:
          $(git diff --staged --name-only)"
            git push
          fi
