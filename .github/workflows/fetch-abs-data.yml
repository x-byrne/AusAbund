name: Fetch ABS Data Snapshot

on:
  # Run on the 2nd of every month at 02:00 UTC — shortly after typical ABS release dates
  schedule:
    - cron: "0 2 2 * *"

  # Allow manual runs from the Actions tab (useful for initial setup / backfill)
  workflow_dispatch:

jobs:
  fetch-abs:
    name: Snapshot CPI and AWE from ABS Data API
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      ABS_API:    "https://data.api.abs.gov.au/rest/data"
      USER_AGENT: "AustralianAbundanceIndex/1.0 (github-actions; open-source research)"

      # ── CPI ──────────────────────────────────────────────────────────────────
      # Quarterly All Groups CPI, weighted average of 8 capital cities
      # Key structure: MEASURE.INDEX.TSEST.REGION.FREQ  (5 dimensions)
      #   MEASURE = 1     → Index Numbers
      #   INDEX   = 10001 → All groups CPI
      #   TSEST   = 10    → Original (not seasonally adjusted)
      #   REGION  = 50    → Weighted average of eight capital cities
      #   FREQ    = Q     → Quarterly
      CPI_DATAFLOW: "ABS,CPI"
      CPI_KEY:      "1.10001.10.50.Q"

      # ── CPIgroups ─────────────────────────────────────────────────────────────
      # Quarterly CPI by expenditure group (All groups + 11 sub-groups),
      # weighted average of 8 capital cities — used for the "chart of the century"
      # Key structure: MEASURE.INDEX.TSEST.REGION.FREQ  (5 dimensions)
      #   MEASURE = 1
      #   INDEX   = 10001 (All groups) + 20001–20006, 115486, 115488, 115489,
      #             115493, 126670 (expenditure groups)
      #   TSEST   = 10    → Original (not seasonally adjusted)
      #   REGION  = 50    → Weighted average of eight capital cities
      #   FREQ    = Q     → Quarterly
      CPIGROUPS_DATAFLOW: "ABS,CPI"
      CPIGROUPS_KEY:      "1.10001+20001+20002+20003+20004+20005+20006+115486+115488+115489+115493+126670.10.50.Q"

      # ── AWE ──────────────────────────────────────────────────────────────────
      # Average Weekly Earnings, half-yearly (May / November reference periods)
      # Key structure: MEASURE.ESTIMATE_TYPE.SEX.SECTOR.INDUSTRY.TSEST.REGION.FREQ
      #   MEASURE       = 3   → Full-time adult average weekly ordinary time earnings
      #   ESTIMATE_TYPE = 1   → Earnings
      #   SEX           = 3   → Persons
      #   SECTOR        = 7   → Private and Public
      #   INDUSTRY      = TOT → All Industries
      #   TSEST         = 10  → Original (not seasonally adjusted)
      #   REGION        = AUS → Australia
      #   FREQ          = S   → Half-yearly, semester
      AWE_DATAFLOW: "ABS,AWE"
      AWE_KEY:      "3.1.3.7.TOT.10.AUS.S"

      # ── LCI ──────────────────────────────────────────────────────────────────
      # Selected Living Cost Indexes, employee households, quarterly
      # Key structure: MEASURE.INDEX.HOUSEHOLD_TYPE.REGION.FREQ  (5 dimensions)
      #   MEASURE        = 1     → Index Number
      #   INDEX          = 10001 → All groups
      #   HOUSEHOLD_TYPE = P1    → Employee households
      #   REGION         = 50    → Weighted average of eight capital cities
      #   FREQ           = Q     → Quarterly
      LCI_DATAFLOW: "ABS,LCI"
      LCI_KEY:      "1.10001.P1.50.Q"

      # ── LCIgroups ─────────────────────────────────────────────────────────────
      # LCI by expenditure group (All groups + sub-groups), employee households —
      # used for the "chart of the century" (LCI-based variant)
      # Key structure: MEASURE.INDEX.HOUSEHOLD_TYPE.REGION.FREQ  (5 dimensions)
      #   MEASURE        = 1
      #   INDEX          = 10001 (All groups) + 20001–20006, 115486, 115488, 115489,
      #                    115493, 126670, 131278, 131279 (expenditure groups)
      #   HOUSEHOLD_TYPE = P1    → Employee households
      #   REGION         = 50    → Weighted average of eight capital cities
      #   FREQ           = Q     → Quarterly
      LCIGROUPS_DATAFLOW: "ABS,LCI"
      LCIGROUPS_KEY:      "1.10001+20001+20002+20003+20004+20005+20006+115486+115488+115489+115493+126670+131278+131279.P1.50.Q"

      # ── WPI ──────────────────────────────────────────────────────────────────
      # Wage Price Index, quarterly
      # Key structure: MEASURE.INDEX.SECTOR.INDUSTRY.TSEST.REGION.FREQ  (7 dimensions)
      #   MEASURE  = 1      → Quarterly Index
      #   INDEX    = THRPEB → Total hourly rates of pay excluding bonuses
      #   SECTOR   = 7      → Private and Public
      #   INDUSTRY = TOT    → All Industries
      #   TSEST    = 20     → Seasonally Adjusted
      #   REGION   = AUS    → Australia
      #   FREQ     = Q      → Quarterly
      WPI_DATAFLOW: "ABS,WPI"
      WPI_KEY:      "1.THRPEB.7.TOT.20.AUS.Q"

    steps:

      # ── 1. Checkout repo so we can commit the snapshots back ─────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Create output directory structure ─────────────────────────────────
      - name: Create data directories
        run: |
          mkdir -p data/cpi data/cpigroups data/awe data/lci data/lcigroups data/wpi

      # ── 3a. Fetch CPI — JSON ─────────────────────────────────────────────────
      - name: Fetch CPI (JSON)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+json;version=1.0" \
            "$ABS_API/$CPI_DATAFLOW/$CPI_KEY?detail=full" \
            -o data/cpi/cpi.json
          echo "CPI JSON: $(wc -c < data/cpi/cpi.json) bytes"

      # ── 3b. Fetch CPI — CSV ──────────────────────────────────────────────────
      - name: Fetch CPI (CSV)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+csv;version=1.0.0" \
            "$ABS_API/$CPI_DATAFLOW/$CPI_KEY?detail=dataonly" \
            -o data/cpi/cpi.csv
          echo "CPI CSV rows: $(wc -l < data/cpi/cpi.csv)"

      # ── 4a. Fetch CPIgroups — JSON ────────────────────────────────────────────
      - name: Fetch CPIgroups (JSON)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+json;version=1.0" \
            "$ABS_API/$CPIGROUPS_DATAFLOW/$CPIGROUPS_KEY?detail=full" \
            -o data/cpigroups/cpigroups.json
          echo "CPIgroups JSON: $(wc -c < data/cpigroups/cpigroups.json) bytes"

      # ── 4b. Fetch CPIgroups — CSV ─────────────────────────────────────────────
      - name: Fetch CPIgroups (CSV)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+csv;version=1.0.0" \
            "$ABS_API/$CPIGROUPS_DATAFLOW/$CPIGROUPS_KEY?detail=dataonly" \
            -o data/cpigroups/cpigroups.csv
          echo "CPIgroups CSV rows: $(wc -l < data/cpigroups/cpigroups.csv)"

      # ── 5a. Fetch AWE — JSON ─────────────────────────────────────────────────
      - name: Fetch AWE (JSON)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+json;version=1.0" \
            "$ABS_API/$AWE_DATAFLOW/$AWE_KEY?detail=full" \
            -o data/awe/awe.json
          echo "AWE JSON: $(wc -c < data/awe/awe.json) bytes"

      # ── 5b. Fetch AWE — CSV ──────────────────────────────────────────────────
      - name: Fetch AWE (CSV)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+csv;version=1.0.0" \
            "$ABS_API/$AWE_DATAFLOW/$AWE_KEY?detail=dataonly" \
            -o data/awe/awe.csv
          echo "AWE CSV rows: $(wc -l < data/awe/awe.csv)"

      # ── 6a. Fetch LCI — JSON ─────────────────────────────────────────────────
      - name: Fetch LCI (JSON)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+json;version=1.0" \
            "$ABS_API/$LCI_DATAFLOW/$LCI_KEY?detail=full" \
            -o data/lci/lci.json
          echo "LCI JSON: $(wc -c < data/lci/lci.json) bytes"

      # ── 6b. Fetch LCI — CSV ──────────────────────────────────────────────────
      - name: Fetch LCI (CSV)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+csv;version=1.0.0" \
            "$ABS_API/$LCI_DATAFLOW/$LCI_KEY?detail=dataonly" \
            -o data/lci/lci.csv
          echo "LCI CSV rows: $(wc -l < data/lci/lci.csv)"

      # ── 7a. Fetch LCIgroups — JSON ────────────────────────────────────────────
      - name: Fetch LCIgroups (JSON)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+json;version=1.0" \
            "$ABS_API/$LCIGROUPS_DATAFLOW/$LCIGROUPS_KEY?detail=full" \
            -o data/lcigroups/lcigroups.json
          echo "LCIgroups JSON: $(wc -c < data/lcigroups/lcigroups.json) bytes"

      # ── 7b. Fetch LCIgroups — CSV ─────────────────────────────────────────────
      - name: Fetch LCIgroups (CSV)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+csv;version=1.0.0" \
            "$ABS_API/$LCIGROUPS_DATAFLOW/$LCIGROUPS_KEY?detail=dataonly" \
            -o data/lcigroups/lcigroups.csv
          echo "LCIgroups CSV rows: $(wc -l < data/lcigroups/lcigroups.csv)"

      # ── 8a. Fetch WPI — JSON ─────────────────────────────────────────────────
      - name: Fetch WPI (JSON)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+json;version=1.0" \
            "$ABS_API/$WPI_DATAFLOW/$WPI_KEY?detail=full" \
            -o data/wpi/wpi.json
          echo "WPI JSON: $(wc -c < data/wpi/wpi.json) bytes"

      # ── 8b. Fetch WPI — CSV ──────────────────────────────────────────────────
      - name: Fetch WPI (CSV)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+csv;version=1.0.0" \
            "$ABS_API/$WPI_DATAFLOW/$WPI_KEY?detail=dataonly" \
            -o data/wpi/wpi.csv
          echo "WPI CSV rows: $(wc -l < data/wpi/wpi.csv)"

      # ── 9. Validate files are non-empty ──────────────────────────────────────
      - name: Validate downloads
        run: |
          for f in data/cpi/cpi.json data/cpi/cpi.csv \
                   data/cpigroups/cpigroups.json data/cpigroups/cpigroups.csv \
                   data/awe/awe.json data/awe/awe.csv \
                   data/lci/lci.json data/lci/lci.csv \
                   data/lcigroups/lcigroups.json data/lcigroups/lcigroups.csv \
                   data/wpi/wpi.json data/wpi/wpi.csv; do
            if [ ! -s "$f" ]; then
              echo "ERROR: $f is empty or missing"
              exit 1
            fi
            echo "OK: $f ($(wc -c < $f) bytes)"
          done

      # ── 10. Write a metadata sidecar with fetch timestamp and source URLs ─────
      - name: Write fetch metadata
        run: |
          cat > data/fetch-metadata.json <<EOF
          {
            "fetched_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "sources": {
              "cpi": {
                "dataflow": "$CPI_DATAFLOW",
                "key": "$CPI_KEY",
                "url": "$ABS_API/$CPI_DATAFLOW/$CPI_KEY"
              },
              "cpigroups": {
                "dataflow": "$CPIGROUPS_DATAFLOW",
                "key": "$CPIGROUPS_KEY",
                "url": "$ABS_API/$CPIGROUPS_DATAFLOW/$CPIGROUPS_KEY"
              },
              "awe": {
                "dataflow": "$AWE_DATAFLOW",
                "key": "$AWE_KEY",
                "url": "$ABS_API/$AWE_DATAFLOW/$AWE_KEY"
              },
              "lci": {
                "dataflow": "$LCI_DATAFLOW",
                "key": "$LCI_KEY",
                "url": "$ABS_API/$LCI_DATAFLOW/$LCI_KEY"
              },
              "lcigroups": {
                "dataflow": "$LCIGROUPS_DATAFLOW",
                "key": "$LCIGROUPS_KEY",
                "url": "$ABS_API/$LCIGROUPS_DATAFLOW/$LCIGROUPS_KEY"
              },
              "wpi": {
                "dataflow": "$WPI_DATAFLOW",
                "key": "$WPI_KEY",
                "url": "$ABS_API/$WPI_DATAFLOW/$WPI_KEY"
              }
            },
            "notes": {
              "cpi_measure":            "1 = Index Numbers",
              "cpi_index":              "10001 = All groups CPI",
              "cpi_tsest":              "10 = Original (not seasonally adjusted)",
              "cpi_region":             "50 = Weighted average of eight capital cities",
              "cpi_freq":               "Q = Quarterly",
              "cpigroups_measure":      "1 = Index Numbers",
              "cpigroups_index":        "10001 = All groups; 20001-20006, 115486, 115488, 115489, 115493, 126670 = expenditure groups",
              "cpigroups_tsest":        "10 = Original (not seasonally adjusted)",
              "cpigroups_region":       "50 = Weighted average of eight capital cities",
              "cpigroups_freq":         "Q = Quarterly",
              "awe_measure":            "3 = Full-time adult average weekly ordinary time earnings",
              "awe_estimate_type":      "1 = Earnings",
              "awe_sex":                "3 = Persons",
              "awe_sector":             "7 = Private and Public",
              "awe_industry":           "TOT = All Industries",
              "awe_tsest":              "20 = Original (not seasonally adjusted)",
              "awe_region":             "AUS = Australia",
              "awe_freq":               "S = Half-yearly, semester",
              "lci_measure":            "1 = Index Number",
              "lci_index":              "10001 = All groups",
              "lci_household":          "P1 = Employee households",
              "lci_region":             "50 = Weighted average of eight capital cities",
              "lci_freq":               "Q = Quarterly",
              "lcigroups_measure":      "1 = Index Number",
              "lcigroups_index":        "10001 = All groups; 20001-20006, 115486, 115488, 115489, 115493, 126670, 131278, 131279 = expenditure groups",
              "lcigroups_household":    "P1 = Employee households",
              "lcigroups_region":       "50 = Weighted average of eight capital cities",
              "lcigroups_freq":         "Q = Quarterly",
              "wpi_measure":            "1 = Quarterly Index",
              "wpi_index":              "THRPEB = Total hourly rates of pay excluding bonuses",
              "wpi_sector":             "7 = Private and Public",
              "wpi_industry":           "TOT = All Industries",
              "wpi_tsest":              "20 = Seasonally Adjusted",
              "wpi_region":             "AUS = Australia",
              "wpi_freq":               "Q = Quarterly"
            }
          }
          EOF

      # ── 11. Commit and push updated data files ───────────────────────────────
      - name: Commit snapshot to repository
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          # Only commit if there are actual changes
          if git diff --staged --quiet; then
            echo "No data changes detected — ABS has not updated since last run."
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "data: ABS snapshot ${TIMESTAMP}

          Updated files:
          $(git diff --staged --name-only)"
            git push
          fi

      # ── 12. Purge jsDelivr CDN cache so the page picks up fresh data ─────────
      - name: Purge jsDelivr cache
        run: |
          for f in data/cpi/cpi.csv data/cpigroups/cpigroups.csv \
                   data/awe/awe.csv \
                   data/lci/lci.csv data/lcigroups/lcigroups.csv \
                   data/wpi/wpi.csv; do
            curl --silent --show-error --fail \
              "https://purge.jsdelivr.net/gh/x-byrne/AusAbund@main/${f}"
            echo "Purged: $f"
          done
