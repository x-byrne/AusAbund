name: Fetch ABS Data Snapshot

on:
  # Run on the 2nd of every month at 02:00 UTC — shortly after typical ABS release dates
  schedule:
    - cron: "0 2 2 * *"

  # Allow manual runs from the Actions tab (useful for initial setup / backfill)
  workflow_dispatch:

jobs:
  fetch-abs:
    name: Snapshot CPI and AWE from ABS Data API
    runs-on: ubuntu-latest

    env:
      ABS_API:    "https://data.api.abs.gov.au/rest/data"
      USER_AGENT: "AustralianAbundanceIndex/1.0 (github-actions; open-source research)"

      # ── CPI ──────────────────────────────────────────────────────────────────
      # Quarterly All Groups CPI, weighted average of 8 capital cities
      # Key structure: MEASURE.INDEX.TSEST.REGION.FREQ  (5 dimensions)
      #   MEASURE = 1     → Index Numbers
      #   INDEX   = 10001 → All groups CPI
      #   TSEST   = 10    → Original (not seasonally adjusted)
      #   REGION  = 50    → Weighted average of eight capital cities
      #   FREQ    = Q     → Quarterly
      CPI_DATAFLOW: "ABS,CPI"
      CPI_KEY:      "1.10001.10.50.Q"

      # ── AWE ──────────────────────────────────────────────────────────────────
      # Average Weekly Earnings, semi-annual (May / November reference periods)
      # Key structure: MEASURE.EMP_TYPE.INDUSTRY.TSEST.REGION.FREQ
      #   MEASURE   = 1   → Average Weekly Total Earnings
      #   EMP_TYPE  = 3   → All employees
      #   INDUSTRY  = 3   → All industries
      #   TSEST     = 20  → Original (not seasonally adjusted)
      #   REGION    = AUS → Australia
      #   FREQ      = S   → Semi-annual
      AWE_DATAFLOW: "ABS,AWE"
      AWE_KEY:      "3.1.3.7.TOT.20.AUS.S"

    steps:

      # ── 1. Checkout repo so we can commit the snapshots back ─────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Create output directory structure ─────────────────────────────────
      - name: Create data directories
        run: |
          mkdir -p data/cpi data/awe

      # ── 3a. Fetch CPI — JSON ─────────────────────────────────────────────────
      - name: Fetch CPI (JSON)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+json;version=1.0" \
            "$ABS_API/$CPI_DATAFLOW/$CPI_KEY?detail=full" \
            -o data/cpi/cpi.json
          echo "CPI JSON: $(wc -c < data/cpi/cpi.json) bytes"

      # ── 3c. Fetch CPI — CSV (SDMX-CSV, easiest for JS consumption) ──────────
      - name: Fetch CPI (CSV)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+csv;version=1.0.0" \
            "$ABS_API/$CPI_DATAFLOW/$CPI_KEY?detail=dataonly" \
            -o data/cpi/cpi.csv
          echo "CPI CSV rows: $(wc -l < data/cpi/cpi.csv)"

      # ── 4a. Fetch AWE — JSON ─────────────────────────────────────────────────
      - name: Fetch AWE (JSON)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+json;version=1.0" \
            "$ABS_API/$AWE_DATAFLOW/$AWE_KEY?detail=full" \
            -o data/awe/awe.json
          echo "AWE JSON: $(wc -c < data/awe/awe.json) bytes"

      # ── 4c. Fetch AWE — CSV ──────────────────────────────────────────────────
      - name: Fetch AWE (CSV)
        run: |
          curl --silent --show-error --fail \
            --retry 3 --retry-delay 5 \
            --max-time 60 \
            -H "User-Agent: $USER_AGENT" \
            -H "Accept: application/vnd.sdmx.data+csv;version=1.0.0" \
            "$ABS_API/$AWE_DATAFLOW/$AWE_KEY?detail=dataonly" \
            -o data/awe/awe.csv
          echo "AWE CSV rows: $(wc -l < data/awe/awe.csv)"

      # ── 5. Validate files are non-empty ──────────────────────────────────────
      - name: Validate downloads
        run: |
          for f in data/cpi/cpi.jso data/cpi/cpi.csv \
                   data/awe/awe.json data/awe/awe.csv; do
            if [ ! -s "$f" ]; then
              echo "ERROR: $f is empty or missing"
              exit 1
            fi
            echo "OK: $f ($(wc -c < $f) bytes)"
          done

      # ── 6. Write a metadata sidecar with fetch timestamp and source URLs ─────
      - name: Write fetch metadata
        run: |
          cat > data/fetch-metadata.json <<EOF
          {
            "fetched_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "sources": {
              "cpi": {
                "dataflow": "$CPI_DATAFLOW",
                "key": "$CPI_KEY",
                "url": "$ABS_API/$CPI_DATAFLOW/$CPI_KEY"
              },
              "awe": {
                "dataflow": "$AWE_DATAFLOW",
                "key": "$AWE_KEY",
                "url": "$ABS_API/$AWE_DATAFLOW/$AWE_KEY"
              }
            },
            "notes": {
              "cpi_measure": "1 = Index Numbers",
              "cpi_index":   "10001 = All groups CPI",
              "cpi_tsest":   "10 = Original (not seasonally adjusted)",
              "cpi_region":  "50 = Weighted average of eight capital cities",
              "cpi_freq":    "Q = Quarterly",
              "awe_measure": "1 = Average Weekly Total Earnings",
              "awe_emp":     "3 = All employees",
              "awe_industry":"3 = All industries",
              "awe_tsest":   "20 = Original (not seasonally adjusted)",
              "awe_freq":    "S = Semi-annual (May / November reference periods)"
            }
          }
          EOF

      # ── 7. Commit and push updated data files ────────────────────────────────
      - name: Commit snapshot to repository
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          # Only commit if there are actual changes
          if git diff --staged --quiet; then
            echo "No data changes detected — ABS has not updated since last run."
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "data: ABS snapshot ${TIMESTAMP}

          Updated files:
          $(git diff --staged --name-only)"
            git push
          fi
